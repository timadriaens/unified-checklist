# Get related information

In this chapter we retrieve related information for taxa on the checklists (with a valid distribution).

```{r setup_get_information, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(here)           # To find files
library(janitor)        # To clean input data
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(trias)          # To use functions developed for TrIAS
```

## Read data

```{r}
taxa <- read_csv(here("data", "raw", "taxa.csv"))
```

## Filter checklist taxa

Important: if a checklist has related information for a taxon, but not a valid distribution, that related information will NOT be included in the unified checklist. This is to exclude related information about a taxon for which the checklist did not even consider a Belgian scope (e.g. pathway).

```{r}
taxon_keys <- taxa %>%
  filter(validDistribution) %>%
  pull(taxonKey)
```

## Get distributions

```{r get_distributions_from_gbif}
progress_bar <- progress_estimated(length(taxon_keys))

distributions <- map_dfr(taxon_keys, function(x) {
  progress_bar$tick()$print()
  rgbif::name_usage(
    key = x,
    return = "data",
    data = "distribution"
  )
})
```

Save to CSV:

```{r}
write_csv(distributions, here("data", "raw", "distributions.csv"), na = "")
```

## Get species profiles

```{r get_speciesprofiles_from_gbif}
progress_bar <- progress_estimated(length(taxon_keys))

speciesprofiles <- map_dfr(taxon_keys, function(x) {
  progress_bar$tick()$print()
  rgbif::name_usage(
    key = x,
    return = "data",
    data = "speciesProfiles"
  )
})
```

Save to CSV:

```{r}
write_csv(speciesprofiles, here("data", "raw", "speciesprofiles.csv"), na = "")
```

## Get descriptions

```{r get_descriptions_from_gbif}
progress_bar <- progress_estimated(length(taxon_keys))

descriptions <- map_dfr(taxon_keys, function(x) {
  progress_bar$tick()$print()
  rgbif::name_usage(
    key = x,
    return = "data",
    data = "description"
  )
})
```

Save to CSV:

```{r}
write_csv(descriptions, here("data", "raw", "descriptions.csv"), na = "")
```
