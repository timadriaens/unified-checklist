---
title: "Get related information"
author:
- Peter Desmet
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
---

In this document we retrieve related information for each taxon.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(here)           # To find files
library(janitor)        # To clean input data
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(trias)          # To use functions developed for TrIAS
```

# Read data

```{r}
checklist_taxa <- read_csv(here("data", "interim", "checklist_taxa.csv"))
```

# Filter checklist taxa

Important: if a checklist has related information for a taxon, but not a valid distribution, that related information will NOT be included in the unified checklist. This is to exclude related information about a taxon for which the checklist did not even consider a Belgian scope (e.g. pathway).

```{r}
checklist_taxon_keys <- checklist_taxa %>%
  filter(valid_distribution) %>%
  top_n(10, key) %>%
  pull(key)
```

# Get distributions

```{r get_distributions_from_gbif}
progress_bar <- progress_estimated(length(checklist_taxon_keys))

distribution <- map_dfr(checklist_taxon_keys, function(x) {
  progress_bar$tick()$print()
  rgbif::name_usage(
    key = x,
    return = "data",
    data = "distribution"
  )
})
```

Save to CSV:

```{r}
write_csv(distribution, here("data", "interim", "distribution.csv"), na = "")
```

# Get species profiles

```{r get_speciesprofiles_from_gbif}
progress_bar <- progress_estimated(length(checklist_taxon_keys))

speciesprofile <- map_dfr(checklist_taxon_keys, function(x) {
  progress_bar$tick()$print()
  rgbif::name_usage(
    key = x,
    return = "data",
    data = "speciesProfiles"
  )
})
```

Save to CSV:

```{r}
write_csv(speciesprofile, here("data", "interim", "speciesprofile.csv"), na = "")
```

# Get descriptions

```{r get_descriptions_from_gbif}
progress_bar <- progress_estimated(length(checklist_taxon_keys))

description <- map_dfr(checklist_taxon_keys, function(x) {
  progress_bar$tick()$print()
  rgbif::name_usage(
    key = x,
    return = "data",
    data = "description"
  )
})
```

Save to CSV:

```{r}
write_csv(description, here("data", "interim", "description.csv"), na = "")
```
