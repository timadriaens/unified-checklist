---
title: "Get taxa from checklists"
author:
- Damiano Oldoni
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
# Tidyverse packages
library(dplyr)
library(magrittr)
library(purrr)

# Other packages
library(lazyeval)
library(rgbif)
library(trias)
```

Set file paths:

```{r}
taxa_output_file <- "../data/output/checklist_taxa.tsv"
```

## Select checklist datasets

These are the alien species checklists we want to use and combine:

```{r}
checklist_datasets <- c(
  "9ff7d317-609b-4c08-bd86-3bc404b77c42", # Manual of the Alien Plants of Belgium
  "e4746398-f7c4-47a1-a474-ae80a4f18e92"  # Invasive Alien Species in Belgium - HARMONIA database
)
```

Call `http://api.gbif.org/v1/datasets/{uuid}` for each dataset to get dataset metadata:

```{r get_dataset_metadata}
checklist_datasets_info <- map(checklist_datasets, function (x) rgbif::datasets(uuid = x))
```

Show info about these datasets:

```{r}
map_dfr(checklist_datasets_info, function(x) list(
  datasetKey = x$data$key,
  title = x$data$title,
  modified = x$data$modified,
  publisher = x$data$publishingOrganizationKey,
  doi = x$data$doi)
)
```

## Get taxa from checklists

Call `http://api.gbif.org/v1/species/search?datasetKey={uuid}` for each dataset to get taxon information. As no paging is yet implemented for this API in `rgbif`, we use a function from our `trias` package:

```{r get_checklist_taxa}
checklist_taxa_info <- trias::checklists_import(
  checklist_datasets,
  tot_limit = NULL, 
  verbose = TRUE
)
```

Create df with the information we want for each taxon:

```{r}
checklist_taxa <- map_dfr(checklist_taxa_info, function(x) list(
  key = x$data$key,
  dataset_scientificName = x$data$scientificName,
  datasetKey = x$data$datasetKey,
  nubKey = x$data$nubKey
))
```

Reorder columns:

```{r}
checklist_taxa %<>% select(nubKey, key, dataset_scientificName, datasetKey)
```

Sort by nubKey:

```{r}
checklist_taxa %<>% arrange(nubKey)
```

Show some stats:

```{r}
checklist_taxa %>%
  group_by(datasetKey) %>%
  summarize(
    taxa = n(),
    taxa_not_in_backbone = sum(is.na(nubKey))
  )
```

Total number of taxa:

```{r}
nrow(checklist_taxa)
```

Create a vector of unique `nubKey`s (= the corresponding taxon in the GBIF Backbone Taxonomy, if found). This list will be used to retrieve GBIF Backbone Taxonomy information. Having a list with unique keys avoids multiple calls for the same `nubKey`.

```{r}
checklist_taxa %>%
  select(nubKey) %>%
  filter(!is.na(nubKey)) %>%
  distinct(nubKey) -> nub_keys
```

Number of `nubKey`s:

```{r}
length(nub_keys)
```

## Get GBIF Backbone Taxonomy information:

Select the taxon properties we want from the API:

```{r}
taxon_properties = c(
  "key",
  "scientificName",
  "kingdom",
  "taxonomicStatus",
  "acceptedKey",
  "accepted"
)
```

Call `http://api.gbif.org/v1/species/{int}` for each `nubKey` to get taxon information:

```{r get_backbone_taxa}
nub_keys %>% rowwise() %>% 
  do_(interp(~ as.data.frame(name_usage(key = .$x)$data), 
             x = as.name("nubKey"))) %>% select(taxon_properties) -> backbone_taxa
```

Join GBIF Backbone Taxonomy information with the original taxa. Some taxa will share a `nubKey` (same species appearing on different checklists) and some will have no `nubKey` (they were not found in the GBIF Backbone Taxonomy):

```{r}
checklist_taxa_with_backbone <- left_join(checklist_taxa, backbone_taxa, by = c("nubKey" ="key"))
```

Number of taxa (should be the same as the original number of taxa = `r nrow(checklist_taxa)`):

```{r}
nrow(checklist_taxa_with_backbone)
```

Preview taxa:

```{r}
head(checklist_taxa_with_backbone)
```

Rename column names in order to distinguish info from checklist and GBIF Backbone Taxonomy:

```{r}
checklist_taxa_with_backbone %<>% rename(
  "checklist_taxonKey" = "key",
  "checklist_scientificName" = "dataset_scientificName",
  "checklist_datasetKey" = "datasetKey",
  "backbone_taxonKey" = "nubKey",
  "backbone_scientificName" = "scientificName",
  "backbone_kingdom" = "kingdom",
  "backbone_taxonomicStatus" = "taxonomicStatus",
  "backbone_acceptedKey" = "acceptedKey",
  "backbone_accepted" = "accepted"
)
```

Save taxa to a tsv file:

```{r}
write.table(checklist_taxa_with_backbone, file = taxa_output_file, quote = FALSE, sep = "\t", na = "",  row.names = FALSE)
```
