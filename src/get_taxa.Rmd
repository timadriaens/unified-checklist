---
title: "Get taxa from checklists"
author:
- Damiano Oldoni
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

This document describes how retrieve the taxa from our checklists.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

```{r}
devtools::install_github("trias-project/trias", ref = devtools::github_pull(6)) # Update once PR is accepted
devtools::install_github("ropensci/rgbif")
```

Load libraries:

```{r}
# Tidyverse packages
library(dplyr)
library(magrittr)
library(purrr)

# Other packages
library(lazyeval)
library(rgbif)
library(trias)
```

Set file paths:

```{r}
taxa_output_file <- "../data/output/checklist_taxa.tsv"
```

# Select checklist datasets

These are the alien species checklist datasets we want to use and combine:

```{r}
checklists <- c(
  "289244ee-e1c1-49aa-b2d7-d379391ce265", # Inventory of alien macroinvertebrates in Flanders, Belgium
  "e4746398-f7c4-47a1-a474-ae80a4f18e92"  # Invasive Alien Species in Belgium - HARMONIA database
)
```

Get metadata of these checklist from GBIF:

```{r get_dataset_metadata}
checklists_metadata <- map(checklists, function(x) rgbif::datasets(uuid = x))
```

Preview metadata to ensure we have the correct ones:

```{r}
map_dfr(checklists_metadata, function(x) list(
  datasetKey = x$data$key,
  title = x$data$title,
  modified = x$data$modified,
  publisher = x$data$publishingOrganizationKey,
  doi = x$data$doi)
)
```

# Get taxa

For each checklist, get the taxa from GBIF.

**Note**: here we return checklist taxa, not backbone taxa.

```{r get_checklist_taxa}
checklist_taxa_all_fields <- trias::get_taxa(
  checklist_keys = checklists,
  taxon_keys = NULL,
  limit = NULL
)
```

```{r}
head(checklist_taxa_all_fields, 20)
```

Create a data frame with the information we want for each taxon:

```{r}
checklist_taxa <- checklist_taxa_all_fields %>%
  select(key, scientificName, datasetKey, nubKey) %>%
  arrange(key)
```

Show some stats:

```{r}
checklist_taxa %>%
  group_by(datasetKey) %>%
  summarize(
    taxa = n(),
    taxa_not_in_backbone = sum(is.na(nubKey))
  )
```

Total number of taxa:

```{r}
nrow(checklist_taxa)
```

Save taxa to a tsv file:

```{r}
write.table(checklist_taxa, file = taxa_output_file, quote = FALSE, sep = "\t", na = "",  row.names = FALSE)
```
