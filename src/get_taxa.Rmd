---
title: "Get taxa from checklists"
author:
- Damiano Oldoni
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

This document describes how retrieve the taxa from our checklists.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r set_encoding}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

```{r install_packages}
devtools::install_github("trias-project/trias", ref = devtools::github_pull(6)) # Update once PR is accepted
devtools::install_github("ropensci/rgbif")
```

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(dplyr)
library(magrittr)
library(purrr)

# Other packages
library(lazyeval)
library(rgbif)
library(trias)
```

Set file paths:

```{r set_output_file_path}
taxa_output_file <- "../data/output/checklist_taxa.tsv"
```

# Select checklist datasets

These are the alien species checklist datasets we want to use and combine:

```{r define_checklists}
checklists <- c(
  "289244ee-e1c1-49aa-b2d7-d379391ce265", # Inventory of alien macroinvertebrates in Flanders, Belgium
  "e4746398-f7c4-47a1-a474-ae80a4f18e92"  # Invasive Alien Species in Belgium - HARMONIA database
)
```

Get metadata of these checklist from GBIF:

```{r get_checklist_metadata_from_gbif}
checklists_metadata <- map(checklists, function(x) rgbif::datasets(uuid = x))
```

Preview metadata to ensure we have the correct checklists:

```{r preview_metadata}
map_dfr(checklists_metadata, function(x) list(
  datasetKey = x$data$key,
  title = x$data$title,
  modified = x$data$modified,
  publisher = x$data$publishingOrganizationKey,
  doi = x$data$doi)
)
```

# Get taxa

For each checklist, get the taxa from GBIF.

**Note**: here we return checklist taxa, not backbone taxa.

```{r get_taxa_from_gbif}
checklist_taxa_all_fields <- trias::get_taxa(
  checklist_keys = checklists,
  taxon_keys = NULL,
  limit = NULL
)
```

Preview data:

```{r preview_taxa}
head(checklist_taxa_all_fields, 20)
```

Create a data frame with the information we want for each taxon:

```{r select_columns}
checklist_taxa <- checklist_taxa_all_fields %>%
  select(key, scientificName, datasetKey, nubKey) %>%
  arrange(key)
```

Show some stats:

```{r show_taxa_stats_per_checklist}
checklist_taxa %>%
  group_by(datasetKey) %>%
  summarize(
    taxa = n(),
    taxa_not_in_backbone = sum(is.na(nubKey))
  )
```

Total number of taxa:

```{r show_total_taxa}
nrow(checklist_taxa)
```

# Filter on distribution

Our checklists might contain more than alien species in Belgium. We therefore use the `trias::has_distribution()` function to filter on the [distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml) information.

We will filter on:

* `countryCode = BE`: distributions in Belgium. Regional distributions within Belgium are also considered.
* `establishmentMeans = INTRODUCED`: [GBIF enum](http://gbif.github.io/parsers/apidocs/org/gbif/api/vocabulary/EstablishmentMeans.html) for non-native/alien/exotic/introduced distributions
* `occurrenceStatus = PRESENT`: presence distributions. Historical distributions (e.g. with an ending date in event date) are also considered.

**Note**: we filter on distribution information of our _checklist taxa_, not backbone taxa. That is because backbone taxa contain distribution information from our own checklists _and_ other checklists, which we don't want to consider here.

E.g. compare:

* Distributions for _checklist_ taxon [Eriocheir sinensis](https://api.gbif.org/v1/species/140563012/distributions) (`140563012`)
* Distributions for _backbone_ taxon [Eriocheir sinensis](https://api.gbif.org/v1/species/2225776/distributions) (`2225776`)

Get distribution for all taxa and append `TRUE`/`FALSE` result as extra column:

```{r check_distributions_on_gbif}
checklist_taxa %<>%
  rowwise() %>%
  mutate(valid_distribution = has_distribution(
    taxon_key = .data$key,
    country = "BE",
    establishmentMeans = "INTRODUCED",
    status = "PRESENT"
  ))
```

Preview results:

```{r preview_has_distribution}
checklist_taxa %>%
  select(key, scientificName, valid_distribution) %>%
  head(20)
```

Show some stats:

```{r show_distribution_stats_per_checklist}
checklist_taxa %>%
  group_by(datasetKey) %>%
  summarize(
    taxa = n(),
    taxa_with_valid_distribution = sum(valid_distribution),
    taxa_without_valid_distribution = sum(!valid_distribution)
  )
```

# Save output

Save taxa to a tsv file:

```{r}
write.table(checklist_taxa, file = taxa_output_file, quote = FALSE, sep = "\t", na = "",  row.names = FALSE)
```
