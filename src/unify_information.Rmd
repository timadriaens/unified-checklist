---
title: "Unify related information"
author:
- Peter Desmet
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
---

In this document we unify related information for each verified taxon.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(here)           # To find files
library(janitor)        # To clean input data
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(trias)          # To use functions developed for TrIAS
```

# Read data

```{r}
distribution <- read_csv(here("data", "test", "input", "distribution.csv"))
speciesprofile <- read_csv(here("data", "test", "input", "speciesprofile.csv"))
description <- read_csv(here("data", "test", "input", "description.csv"))
checklists <- read_csv(here("data", "raw", "checklists.csv"))
taxa <- read_csv(here("data", "raw", "taxa.csv"))
```

# Assign checklist order

Get checklist keys (in order):

```{r}
checklist_keys <- checklists %>%
  pull(datasetKey)
```

Assign checklist order column to taxa:

```{r}
taxa <- taxa %>%
  rowwise() %>%
  mutate(checklistOrder = which(checklist_keys == datasetKey)[1])
```

---

**TO REMOVE**

```{r}
# Temporarily use the bb_key as a unifying key
taxa <- taxa %>%
  rename(verifiedKey = bb_key)
```

---

# Unify distribution

Filter distributions:

```{r}
distributions_unified <- distributions %>%
  
  # Filter on non-native species present in (at least part of) Belgium
  filter(
    country == "BE" &
    establishmentMeans %in% c("INTRODUCED", "NATURALISED", "INVASIVE", "ASSISTED COLONISATION") &
    status %in% c("PRESENT", "COMMON", "RARE", "IRREGULAR")
  )
```

Choose a single distribution within a checklist:

```{r}
distributions_unified <- distributions_unified %>%

  # Join distribution with taxon to get verifiedKey and checklist order
  left_join(taxon, on = taxonID) %>%
  
  # Group by verifiedKey within checklist
  group_by(
    checklist,
    checklist_order,
    verifiedKey
  ) %>%
  
  # Take earliest year, latest year and note taxonIDs
  summarize(
    startYear = min(startYear, na.rm = TRUE),
    endYear = max(endYear, na.rm = TRUE),
    source_taxonID = paste(sort(unique(taxonID)), collapse = ",")
  )
```

Choose a single distribution across checklists:

```{r}
distributions_unified <- distributions_unified %>%
  
  # Sort by checklist order (trustworthiness)
  arrange(checklist_order) %>%
  
  # Group by verifiedKey across checklists
  group_by(verifiedKey) %>%
  
  # Select year of most trustworthy checklist (first one)
  # and note that checklist and its taxonID(s)
  summarize(
    startYear = first(startYear),
    lastYear = first(endYear),
    source_checklist = first(checklist),
    source_taxonID = first(source_taxonID)
  ) %>%

  # Sort by verifiedKey
  arrange(verifiedKey)
```

Save to CSV:

```{r}
write_csv(distributions_unified, here("data", "test", "output", "distributions_unified.csv"), na = "")
```

# Unify species profile

Filter species profiles:

```{r}
speciesprofiles_unified <- speciesprofiles %>%
  
  # Remove species profiles that contain NA for any of the attributes
  # This is rare: normally all attributes are populated or there just isn't a
  # species profile for that species
  filter(
    !is.na(isMarine) &
    !is.na(isFreshwater) &
    !is.na(isTerrestrial)
  )
```

Choose a single species profile within a checklist:

```{r}
speciesprofiles_unified <- speciesprofiles_unified %>%

  # Join species profile with taxon to get verifiedKey and checklist order
  left_join(taxon, on = taxonID) %>%
  
  # Group by verifiedKey within checklist
  group_by(
    checklist,
    checklist_order,
    verifiedKey
  ) %>%
  
  # Take first species profile and note taxonID
  summarize(
    isMarine = first(isMarine),
    isFreshwater = first(isFreshwater),
    isTerrestrial = first(isTerrestrial),
    source_taxonID = first(taxonID)
  )
```

Choose a single species profile across checklists:

```{r}
speciesprofiles_unified <- speciesprofiles_unified %>%
  
  # Sort by checklist order (trustworthiness)
  arrange(checklist_order) %>%
  
  # Group by verifiedKey across checklists
  group_by(verifiedKey) %>%
  
  # Select species profile of most trustworthy checklist (first one)
  # and note that checklist and its taxonID
  summarize(
    isMarine = first(isMarine),
    isFreshwater = first(isFreshwater),
    isTerrestrial = first(isTerrestrial),
    source_checklist = first(checklist),
    source_taxonID = first(source_taxonID)
  ) %>%

  # Sort by verifiedKey
  arrange(verifiedKey)
```

Save to CSV:

```{r}
write_csv(speciesprofiles_unified, here("data", "test", "output", "speciesprofiles_unified.csv"), na = "")
```

# Unify descriptions

Filter descriptions:

```{r}
descriptions_unified <- descriptions %>%
  
  # Filter on non-NA values
  filter(
    !is.na(value)
  )
```

Select unique descriptions (within their type) within a checklist:

```{r}
descriptions_unified <- descriptions_unified %>%

  # Join species profile with taxon to get verifiedKey and checklist order
  left_join(taxon, on = taxonID) %>%
  
  # Group by type and verifiedKey within checklist
  group_by(
    checklist,
    checklist_order,
    type,
    verifiedKey
  ) %>%
  
  # Choose distinct value for that type and verifiedKey
  # If identical values exist within that grouping, distinct() will take 
  # most trustworthy (first one)
  distinct(
    value
  )
```

Select unique descriptions (within their type) across checklists:

```{r}
descriptions_unified <- descriptions_unified %>%
  
  # Sort by checklist order (trustworthiness)
  arrange(checklist_order) %>%
  
  # Group by type and verifiedKey across checklists
  group_by(
    type,
    verifiedKey
  ) %>%
  
  # Choose distinct value for that type and verifiedKey
  distinct(
    value,
    .keep_all = TRUE
  ) %>%

  # Move verifiedKey to beginning and drop checklist_order
  select(verifiedKey, everything(), -checklist_order) %>%
  
  # Rename checklist
  rename(source_checklist = checklist) %>%
  
  # Sort by verifiedKey and type
  arrange(verifiedKey, type)
```

Save to CSV:

```{r}
write_csv(descriptions_unified, here("data", "test", "output", "descriptions_unified.csv"), na = "")
```
