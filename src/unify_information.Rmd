# Unify related information

In this chapter we unify related information for each verified taxon.

```{r setup_unify_information, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Read data

```{r}
checklists <- read_csv(here("data", "raw", "checklists.csv"))
taxa <- read_csv(here("data", "raw", "taxa.csv"))
distributions <- read_csv(here("data", "raw", "distributions.csv"))
speciesprofiles <- read_csv(here("data", "raw", "speciesprofiles.csv"))
descriptions <- read_csv(here("data", "raw", "descriptions.csv"))
```

## Assign checklist order

Get checklist keys (in order):

```{r}
checklist_keys <- checklists %>%
  pull(datasetKey)
```

Assign checklist order column to taxa:

```{r}
taxa <- taxa %>%
  rowwise() %>%
  mutate(checklistOrder = which(checklist_keys == datasetKey)[1])
```

---

**TO REMOVE**

```{r}
# Temporarily use the bb_key as a unifying key
taxa <- taxa %>%
  rename(verifiedKey = bb_key)
```

---

## Unify distribution

Parse `temporal` (eventDate) information:

```{r}
distributions_unified <- distributions %>%
  
  # Split temporal on "/" into startYear and endYear
  # If temporal only contains a single year, then endYear will be empty
  separate(
    temporal,
    into = c("startYear", "endYear"),
    sep = "/",
    remove = FALSE,
    convert = TRUE,
    extra = "drop",
    fill = "right"
  ) %>%
  
  # Only keep the first 4 characters: 1968-11-21 -> 1968
  mutate(startYear = str_sub(startYear, 1, 4), endYear = str_sub(endYear, 1, 4)) %>%
  
  # If endYear is empty (no range), populate it with startYear: 2018 & 2018
  mutate(endYear = if_else(is.na(endYear), startYear, endYear))
```

Filter distributions:

```{r}
distributions_unified <- distributions_unified %>%
  
  # Filter on non-native species present in (at least part of) Belgium
  filter(
    country == "BE" &
    establishmentMeans %in% c("INTRODUCED", "NATURALISED", "INVASIVE", "ASSISTED COLONISATION") &
    status %in% c("PRESENT", "COMMON", "RARE", "IRREGULAR")
  )
```

Choose a single distribution within a checklist:

```{r}
distributions_unified <- distributions_unified %>%

  # Join distribution with taxon to get verifiedKey and checklistOrder
  left_join(taxa, on = taxonKey) %>%
  
  # Remove records that have no verifiedKey (e.g. one wasn't assigned yet)
  filter(!is.na(verifiedKey)) %>%
  
  # Group by verifiedKey within checklist
  group_by(
    datasetKey,
    checklistOrder,
    verifiedKey
  ) %>%
  
  # Take earliest year, latest year and note taxonIDs
  summarize(
    startYear = min(startYear, na.rm = TRUE),
    endYear = max(endYear, na.rm = TRUE),
    sourceTaxa = paste(sort(unique(taxonKey)), collapse = ",")
  )
```

Choose a single distribution across checklists:

```{r}
distributions_unified <- distributions_unified %>%
  
  # Sort by checklist order (trustworthiness)
  arrange(checklistOrder) %>%
  
  # Group by verifiedKey across checklists
  group_by(verifiedKey) %>%
  
  # Select year of most trustworthy checklist (first one)
  # and note that checklist and its taxonKey(s)
  summarize(
    startYear = first(startYear),
    lastYear = first(endYear),
    sourceChecklist = first(datasetKey),
    sourceTaxa = first(sourceTaxa)
  ) %>%

  # Sort by verifiedKey
  arrange(verifiedKey)
```

Save to CSV:

```{r}
write_csv(distributions_unified, here("data", "unified", "distributions.csv"), na = "")
```

## Unify species profiles

Filter species profiles:

```{r}
speciesprofiles_unified <- speciesprofiles %>%
  
  # Remove species profiles that contain NA for any of the attributes
  # This is rare: normally all attributes are populated or there just isn't a
  # species profile for that species
  filter(
    !is.na(marine) &
    !is.na(freshwater) &
    !is.na(terrestrial)
  )
```

Choose a single species profile within a checklist:

```{r}
speciesprofiles_unified <- speciesprofiles_unified %>%

  # Join species profile with taxon to get verifiedKey and checklist order
  left_join(taxa, on = taxonID) %>%
  
  # Remove records that have no verifiedKey (e.g. one wasn't assigned yet)
  filter(!is.na(verifiedKey)) %>%
  
  # Group by verifiedKey within checklist
  group_by(
    datasetKey,
    checklistOrder,
    verifiedKey
  ) %>%
  
  # Take first species profile and note taxonKey
  summarize(
    marine = first(marine),
    freshwater = first(freshwater),
    terrestrial = first(terrestrial),
    sourceTaxon = first(taxonKey)
  )
```

Choose a single species profile across checklists:

```{r}
speciesprofiles_unified <- speciesprofiles_unified %>%
  
  # Sort by checklist order (trustworthiness)
  arrange(checklistOrder) %>%
  
  # Group by verifiedKey across checklists
  group_by(verifiedKey) %>%
  
  # Select species profile of most trustworthy checklist (first one)
  # and note that checklist and its taxonID
  summarize(
    marine = first(marine),
    freshwater = first(freshwater),
    terrestrial = first(terrestrial),
    sourceChecklist = first(datasetKey),
    sourceTaxon = first(sourceTaxon)
  ) %>%

  # Sort by verifiedKey
  arrange(verifiedKey)
```

Save to CSV:

```{r}
write_csv(speciesprofiles_unified, here("data", "unified", "speciesprofiles.csv"), na = "")
```

## Unify descriptions

Filter descriptions:

```{r}
descriptions_unified <- descriptions %>%
  
  # Filter on non-NA descriptions
  filter(
    !is.na(description)
  )
```

Select unique descriptions (within their type) within a checklist:

```{r}
descriptions_unified <- descriptions_unified %>%

  # Join species profile with taxon to get verifiedKey and checklist order
  left_join(taxa, on = taxonKey) %>%
  
  # Remove records that have no verifiedKey (e.g. one wasn't assigned yet)
  filter(!is.na(verifiedKey)) %>%
  
  # Group by type and verifiedKey within checklist
  group_by(
    datasetKey,
    checklistOrder,
    verifiedKey,
    type
  ) %>%
  
  # Choose distinct value for that type and verifiedKey
  # If identical values exist within that grouping, distinct() will take 
  # most trustworthy (first one)
  
  # Note: since we use distinct we can't keep a sourceTaxon (taxonKey)
  distinct(
    description
  )
```

Select unique descriptions (within their type) across checklists:

```{r}
descriptions_unified <- descriptions_unified %>%
  
  # Sort by checklist order (trustworthiness)
  arrange(checklistOrder) %>%
  
  # Group by type and verifiedKey across checklists
  group_by(
    type,
    verifiedKey
  ) %>%
  
  # Choose distinct value for that type and verifiedKey
  distinct(
    description,
    .keep_all = TRUE
  ) %>%

  # Move verifiedKey to beginning and drop checklist_order
  select(verifiedKey, everything(), -checklistOrder) %>%
  
  # Rename checklist
  rename(sourceChecklist = datasetKey) %>%
  
  # Sort by verifiedKey and type
  arrange(verifiedKey, type)
```

Save to CSV:

```{r}
write_csv(descriptions_unified, here("data", "unified", "descriptions.csv"), na = "")
```
