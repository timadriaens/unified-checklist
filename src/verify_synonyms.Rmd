---
title: "Verify synonyms"
author:
- Peter Desmet
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(purrr)

# Other packages
library(here)
library(rgbif)
library(trias)
library(googlesheets)
```

Set file path:

```{r input_file_path}
checklist_metadata_file <- "../data/output/checklist_metadata.tsv"
```


# Load data

Load checklist metadata (ranked by trust):

```{r load_checklist_metadata}
checklist_metadata <- read_tsv(checklist_metadata_file)
checklist_metadata
```

Load taxa information as previously wrangled via checklists and GBIF backbone:

```{r load_taxa}
taxa_file <- "../data/interim/checklist_taxa.tsv"
taxa <- read_tsv(taxa_file)
```

Preview:

```{r}
taxa %>% head(n = 10)
```

Load verified taxa directly from spreadsheet in TrIAS Google Drive:

```{r load_googlesheet, eval = FALSE}
verified_synonyms <- gs_read(ss = "verification_spreadsheet",
                             ws = "verification_sheet")
```

Or via text file:

```{r load_text_file}
verified_synonyms_file <- "../data/output/verified_taxa.tsv"
verified_synonyms <- read_tsv(verified_synonyms_file, 
                              col_types = cols(
                                backbone_taxonKey = col_integer(),
                                backbone_acceptedKey = col_integer(),
                                date_added = col_date(),
                                verification_key = col_character())
                              )
```

Preview:

```{r}
verified_synonyms %>% head(n = 10)
```

# Assign verified key(s) to taxa

We need to verify synonyms and solve unmatches to GBIF backbone. Experts should verify taxa if one of the following conditions holds true:

1. no match with GBIF Backbone (`backbone_taxonKey` is not present)
2. taxonomic status not available or a synonym (`backbone_taxonomicStatus` not `ACCEPTED` or `DOUBTFUL`, see [GBIF taxonomic status page](http://rs.gbif.org/vocabulary/gbif/taxonomic_status.xml) for more details)

In all other cases, we can accept the `backbone_taxonKey` as provided by GBIF backbone:

```{r set_verified_key_equal_to_nubKey_or_NULL}
taxa <- taxa %>% 
  mutate(verification_key = if_else(is.finite(backbone_taxonKey) & 
                                  backbone_taxonomicStatus %in% 
                                  c("ACCEPTED", "DOUBTFUL"),
                                as.character(.data$backbone_taxonKey),
                                NULL))
```

A summary:

```{r stats}
taxa %>% count(verification_key_from_gbif = !is.na(verification_key))
```

Number of synonyms or unmatched taxa already verified by experts:

```{r}
verified_synonyms %>% count(with_verification_key = !is.na(verification_key))
```

We use function `verify_taxa()` from  `trias` package in order to 

1. retrieve verified keys which have been already assigned (stored in `verified_synonyms`)
2. update `verified_synonyms`. Updates include:
  - Updates from GBIF in the scientific names (`checklist_scientificName`, `backbone_scientificName` or `backbone_acceptedName`): those mostly consider slight spelling variations and will be updated in `verified_synonyms` authomatically (a message is returned).
  - New synonyms or no matches to GBIF backbone will be added to `verified_synonyms`.

The function reports also unused rows in `verified_synonyms`, but they will not be removed or altered.

```{r apply_verify_taxa}
verify <- trias::verify_taxa(taxa = taxa %>% 
                               filter(is.na(verification_key)) %>%
                               select(-verification_key), 
                             verified_taxa = verified_synonyms)
```

## New synonyms

The following synonyms are new and should be verified:

```{r new_synonyms}
verify$new_synonyms
```

## New unmatched taxa

The following taxa are not matched to GBIF backbone:

```{r new_unmatched_taxa}
verify$new_unmatched_taxa
```

## Updated names

Consequences of updates in GBIF backbone with no consequences in synonym relation.

### Updated backbone scientific names 

These backbone scientific names have been updated (but synonym relation stayed the same):

```{r updated_scientific_names}
verify$updated_scientificName
```

### Updated backbone accepted scientific names 

These backbone accepted names have been updated (but synonym relation stayed the same):

```{r updated_accepted_names}
verify$updated_acceptedName
```

### Updated issues

The backbone issues related to these taxa have been udpated:

```{r update_backbone_issues}
verify$updated_backbone_issues
```

## Unused taxa

These synonym relations are no longer used:

```{r}
verify$unused_taxa
```

## Check verification keys

We check the verification keys provided by taxonomy experts. In particular, the following checks are performed:

1. `verification_key` is a valid taxon key
2. `verification_key` refers to a taxon in GBIF Backbone
3. `verification_key` is a synonym (neither `ACCEPTED` nor `DOUBTFUL`)

```{r show_invalid_vks_synonym}
vks_status <- trias::gbif_verify_keys(unique(verify$verified_taxa$verification_key)) %>%
  rename(verification_key = key)
vks_status
```

Invalid taxon keys (`valid_taxon_keys` is `FALSE`):

```{r invalid_taxon_keys}
vks_status %>% 
  count(valid_taxon_keys = (is_taxonKey == TRUE))
```

Invalid GBIF backbone keys (`valid_GBIF_backbone_keys` is `FALSE`):

```{r invalid_gbif_backbone_keys}
vks_status %>% 
  count(valid_GBIF_backbone_keys = (is_from_gbif_backbone == TRUE))
```

Synonyms (`is_synonym` is `TRUE`):

```{r}
vks_status %>% 
  count(is_synonym = (is_synonym == TRUE))
```

## Save verification table

The data.frame `verify$verified_taxa` can be saved as text file and manually transferred to online spreadsheet:

```{r save_verification_df_to_tsv}
write_tsv(verify$verified_taxa, 
          path = "../data/output/verified_taxa.tsv",
          na = "")
```

## Update taxa

We can now add the verification keys (and eventual remarks by experts) to taxa:

```{r update_taxa}
taxa_with_vk_from_gbif <- taxa %>%
  filter(!is.na(verification_key)) %>%
  mutate(remarks = NA_character_)

prepare_to_join <- verify$verified_taxa %>%
  separate_rows(checklists, sep = ",") %>%
  rename(checklist_datasetKey = checklists) %>%
  select(-date_added)

taxa_from_verified <- taxa %>%
  filter(is.na(verification_key)) %>%
  select(-verification_key)
taxa_from_verified <- taxa_from_verified %>% 
  left_join(prepare_to_join,
            by = intersect(
              colnames(taxa_from_verified), colnames(prepare_to_join)
              )
            )
taxa <- bind_rows(taxa_with_vk_from_gbif, taxa_from_verified)
```

Shows some stats:

```{r}
print(paste("Number of accepted taxa: ", 
            taxa %>% 
              filter(backbone_taxonomicStatus == "ACCEPTED") %>%
              nrow()))
print(paste("Number of doubtful taxa (but no expert check needed): ", 
            taxa %>% 
              filter(backbone_taxonomicStatus == "DOUBTFUL") %>%
              nrow()))
print(paste("Number of taxa verified by expert: ",
            taxa %>% 
              filter(!is.na(verification_key)) %>%
              filter(verification_key %in% 
                       verify$verified_taxa$verification_key) %>%
              nrow()))
print(paste("Number of taxa still to verify: ",
            taxa %>% 
              filter(is.na(verification_key)) %>%
              nrow())) 
```

Save the updated taxa:

```{r save_udpated_taxa}
# save to csv -> taxa_by_nubKey_verified
taxa_verified <- write_tsv(taxa, 
                           path = "../data/interim/taxa_after_verification.tsv",
                           na = "")
```
 