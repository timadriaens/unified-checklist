---
title: "Verify synonyms"
author:
- Peter Desmet
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(dplyr)
library(readr)

# Other packages
library(rgbif)
library(trias)
library(googlesheets)
```

## Load data

Load checklist metadata (ranked by trust):

```{r load_checklist_metadata}
checklist_metadata_file <- "../data/output/checklist_metadata.tsv"
checklist_metadata <- read_tsv(checklist_metadata_file)
```

Load taxa information (from checklists and GBIF backbone):

```{r load_taxa}
taxa_file <- "../data/output/checklist_taxa.tsv"
taxa <- read_tsv(taxa_file)
```

Preview:

```{r}
taxa %>% head(n = 10)
```

We need to verify synonyms and solve GBIF backbone related issues. Experts should verify taxa with:

1. no match with GBIF Backbone
2. taxonomic status equal to `SYNONYM`
3. backbone issues equal to `FUZZY GBIF BACKBONE MATCH`

Load verified synonyms from spreadsheet in TrIAS Google Drive:

```{r load_googlesheet}
my_sheets <- gs_ls()
```

```{r}
verified_synonyms_file <- "../data/output/verified_synonyms.tsv"
verified_synonyms <- read_tsv(verified_synonyms_file)
```

Preview:

```{r}
verified_synonyms %>% head(n = 10)
```

# Assign verified key(s) to taxa

Taxa which don't need to be reviewed by experts can be easily handled: `verfied_key` is set equal to `nubKey`:

```{r set_verified_key_equal_to_nubKey}
taxa %>% mutate(verified_key = if_else())
```


## Find new synonym combinations

For every key, acceptedKey combination, where acceptedKey is not NA, update verified synonyms:

```{r}
# For every key, acceptedKey -> check in file

# If in file:
# If scientificname + acceptedScientificName different -> update + store in updated_names
# If same -> do nothing

# If not in file -> add new line + store in new_synonyms

# If in synonyms file but not found in grouped_taxa -> add " OUTDATED" to remarks + store in outdated_synonyms
```

## Results

These names have been updated (but synonym relation stayed the same):

```{r}
# updated_names
```

These synonym relations are no longer used:

```{r}
# outdated_synonyms
```

These synonym relations were added and should be verified:

```{r}
# new_synonyms
```

## Update taxa

Add `verified_key`

```{r}
# add column verified_key (is empty)
```

Accept all ACCEPTED and DOUBTFUL:

```{r}
# for taxonomicStatus = ACCEPTED or DOUBTFUL
# verified_key = nubKey
```

Update taxa_by_nubKey with verified synonyms info:

```{r}
# for taxonomicStatus = SYNONYM
# Look up nubKey + acceptedKey in verifiedSynonyms
# populate verified_key
```

Shows some stats:

```{r}
# Number of accepted taxa
# Number of doubtful taxa
# Number of verified synonyms
# Number of unverified synonyms
```

```{r}
# save to csv -> taxa_by_nubKey_verified
```
