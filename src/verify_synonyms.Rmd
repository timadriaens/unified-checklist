---
title: "Verify synonyms"
author:
- Peter Desmet
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(dplyr)
library(readr)

# Other packages
library(rgbif)
library(trias)
library(googlesheets4)
```

Set file path:

```{r input_file_path}
checklist_metadata_file <- "../data/output/checklist_metadata.tsv"
```


# Load data

Load checklist metadata (ranked by trust):

```{r load_checklist_metadata}
checklist_metadata <- read_tsv(checklist_metadata_file)
checklist_metadata
```

Load taxa information as previously wrangled via checklists and GBIF backbone:

```{r load_taxa}
taxa_file <- "../data/output/checklist_taxa.tsv"
taxa <- read_tsv(taxa_file)
```

Preview:

```{r}
taxa %>% head(n = 10)
```

Load verified taxa from spreadsheet in TrIAS Google Drive:

```{r load_googlesheet}
my_sheets <- googlesheets4::read_sheet(ss = "verification_spreadsheet",
                                       sheet = "Sheet1")
```

```{r}
verified_synonyms_file <- "../data/output/verified_synonyms.tsv"
verified_synonyms <- read_tsv(verified_synonyms_file)
```

Preview:

```{r}
verified_synonyms %>% head(n = 10)
```

# Assign verified key(s) to taxa

We need to verify synonyms and solve GBIF backbone related issues. Experts should verify taxa if one of the following conditions holds true:

1. no match with GBIF Backbone (`nubKey` is not present)
2. taxonomic status not available or a synonym (`backbone_taxonomicStatus` not `ACCEPTED` or `DOUBTFUL`, see [GBIF taxonomic status page](http://rs.gbif.org/vocabulary/gbif/taxonomic_status.xml) for more details)
3. a backbone fuzzy match occurred (`backbone_issues` contains `BACKBONE_MATCH_FUZZY`)

In all other cases, we can accept the `nubKey` as provided by GBIF backbone:

```{r set_verified_key_equal_to_nubKey_or_NULL}
taxa <- taxa %>% 
  mutate(verified_key = if_else(is.finite(nubKey) & 
                                  backbone_taxonomicStatus %in% 
                                  c("ACCEPTED", "DOUBTFUL") & 
                                  !str_detect(backbone_issues, 
                                              "BACKBONE_MATCH_FUZZY"),
                                .data$nubKey,
                                NULL))
```

A summary:

```{r stats}
taxa %>% count(with_verified_key = is.finite(verified_key))
```


We use function `verify_taxa()` from  `trias` package in order to 

1. retrieve verified keys which have been already assigned (in `verified_synonyms`)
2. update `verified_synonyms`. Updates include:
  1. Updates from GBIF in the scientific names (`checklist_scientificName`, `backbone_scientificName` or `backbone_acceptedName`): those mostly consider slight spelling variations and will be updated in `verified_synonyms` authomatically (a message is returned).
  2. New synonyms, fuzzy matches or no matches to GBIF backbone will be added to `verified_synonyms`.

The taxa without 

The function reports also unused rows in `verified_synonyms`, but they will not be removed or altered.

## Find new 

For every key, acceptedKey combination, where acceptedKey is not NA, update verified synonyms:

```{r}
# For every key, acceptedKey -> check in file

# If in file:
# If scientificname + acceptedScientificName different -> update + store in updated_names
# If same -> do nothing

# If not in file -> add new line + store in new_synonyms

# If in synonyms file but not found in grouped_taxa -> add " OUTDATED" to remarks + store in outdated_synonyms
```

## Results

These names have been updated (but synonym relation stayed the same):

```{r}
# updated_names
```

These synonym relations are no longer used:

```{r}
# outdated_synonyms
```

These synonym relations were added and should be verified:

```{r}
# new_synonyms
```

## Update taxa

Add `verified_key`

```{r}
# add column verified_key (is empty)
```

Accept all ACCEPTED and DOUBTFUL:

```{r}
# for taxonomicStatus = ACCEPTED or DOUBTFUL
# verified_key = nubKey
```

Update taxa_by_nubKey with verified synonyms info:

```{r}
# for taxonomicStatus = SYNONYM
# Look up nubKey + acceptedKey in verifiedSynonyms
# populate verified_key
```

Shows some stats:

```{r}
# Number of accepted taxa
# Number of doubtful taxa
# Number of verified synonyms
# Number of unverified synonyms
```

```{r}
# save to csv -> taxa_by_nubKey_verified
```
